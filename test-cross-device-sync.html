<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Device Sync Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; font-weight: bold; font-size: 16px; }
        .loading { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .claimed { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .unclaimed { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .sync { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        button { padding: 12px 24px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .start { background: #28a745; color: white; }
        .check { background: #17a2b8; color: white; }
        .reset { background: #dc3545; color: white; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .timer { font-size: 24px; font-weight: bold; text-align: center; margin: 20px 0; padding: 20px; background: #e9ecef; border-radius: 8px; }
        .platform-status { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; }
        .status-indicator { padding: 8px 16px; border-radius: 4px; font-weight: bold; }
        .acquiring { background: #fff3cd; color: #856404; }
        .acquired { background: #d4edda; color: #155724; }
        .not-acquired { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Cross-Device Synchronization Test</h1>
        <p>This test simulates what happens when multiple devices access the same user ID with an active loading state.</p>
        
        <div class="status sync" id="syncStatus">üîÑ Synchronization Status: Ready to Test</div>
        
        <div class="timer" id="timer">‚è∞ Timer: Not Active</div>
        
        <div class="platform-status">
            <span>Instagram Platform Status:</span>
            <div class="status-indicator not-acquired" id="platformStatus">Not Acquired</div>
        </div>
        
        <div>
            <button class="start" onclick="startLoading()">üöÄ Start Loading State</button>
            <button class="check" onclick="checkSync()">üîç Check Synchronization</button>
            <button class="reset" onclick="resetAll()">üîÑ Reset All Data</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        const TEST_USER_ID = 'test-user-123';
        const TEST_PLATFORM = 'instagram';
        let syncInterval = null;
        let timerInterval = null;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.innerHTML += `[${timestamp}] ${emoji} ${message}\n`;
            logElement.scrollTop = logElement.scrollTop + 1000;
        }

        async function startLoading() {
            log('üöÄ Starting cross-device synchronization test...');
            
            try {
                const now = Date.now();
                const durationMs = 15 * 60 * 1000; // 15 minutes
                const endTime = now + durationMs;
                
                log(`‚è∞ Setting timer: ${new Date(endTime).toISOString()}`);
                log(`üì± This simulates Device A starting a loading state`);
                
                // Step 1: Save processing status
                const processingResponse = await fetch(`/api/processing-status/${TEST_USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: TEST_PLATFORM,
                        startTime: now,
                        endTime: endTime,
                        totalDuration: durationMs,
                        username: 'testuser'
                    })
                });
                
                if (processingResponse.ok) {
                    log('‚úÖ Processing status saved to backend (Device A)');
                } else {
                    log(`‚ùå Failed to save processing status: ${processingResponse.status}`, 'error');
                    return;
                }
                
                // Step 2: Mark platform as NOT claimed
                const accessResponse = await fetch(`/api/platform-access/${TEST_USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: TEST_PLATFORM,
                        claimed: false,
                        username: 'testuser'
                    })
                });
                
                if (accessResponse.ok) {
                    log('‚úÖ Platform marked as NOT claimed (loading state)');
                } else {
                    log(`‚ùå Failed to mark platform as NOT claimed: ${accessResponse.status}`, 'error');
                    return;
                }
                
                log('üéØ Loading state started on Device A!');
                log('üì± Now simulate Device B by checking synchronization...');
                
                updateStatus('loading');
                startTimer(endTime);
                startSyncMonitoring();
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkSync() {
            log('üîç Checking cross-device synchronization...');
            log('üì± This simulates Device B checking the same user ID');
            
            try {
                // Check processing status
                const processingResponse = await fetch(`/api/processing-status/${TEST_USER_ID}`);
                if (processingResponse.ok) {
                    const processingData = await processingResponse.json();
                    const platformData = processingData.data[TEST_PLATFORM];
                    
                    if (platformData && platformData.active) {
                        log(`‚úÖ Device B detected active loading state for ${TEST_PLATFORM}`);
                        log(`‚è∞ Timer ends at: ${new Date(platformData.endTime).toISOString()}`);
                        
                        const remainingMs = Math.max(0, platformData.endTime - Date.now());
                        const remainingMinutes = Math.ceil(remainingMs / 1000 / 60);
                        log(`‚è±Ô∏è Remaining time: ${remainingMinutes} minutes`);
                        
                        // Update timer display
                        updateTimerDisplay(remainingMs);
                        
                    } else {
                        log(`‚ùå Device B did NOT detect loading state`, 'error');
                    }
                } else {
                    log(`‚ùå Failed to get processing status: ${processingResponse.status}`, 'error');
                }
                
                // Check platform access status
                const accessResponse = await fetch(`/api/platform-access/${TEST_USER_ID}`);
                if (accessResponse.ok) {
                    const accessData = await accessResponse.json();
                    const accessPlatform = accessData.data[TEST_PLATFORM];
                    
                    if (accessPlatform && accessPlatform.claimed === false) {
                        log(`‚úÖ Device B correctly sees platform as NOT claimed (should show "Acquiring")`);
                        updatePlatformStatus('acquiring');
                    } else {
                        log(`‚ö†Ô∏è Device B sees platform as claimed: ${JSON.stringify(accessPlatform)}`, 'warning');
                        updatePlatformStatus('acquired');
                    }
                } else {
                    log(`‚ùå Failed to get platform access status: ${accessResponse.status}`, 'error');
                }
                
                updateStatus('sync');
                
            } catch (error) {
                log(`‚ùå Error checking sync: ${error.message}`, 'error');
            }
        }

        function startTimer(endTime) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const remainingMs = Math.max(0, endTime - now);
                
                if (remainingMs <= 0) {
                    clearInterval(timerInterval);
                    log('‚è∞ Timer completed!');
                    updateStatus('claimed');
                    updateTimerDisplay(0);
                    updatePlatformStatus('acquired');
                    return;
                }
                
                updateTimerDisplay(remainingMs);
            }, 1000);
        }

        function updateTimerDisplay(remainingMs) {
            const timerElement = document.getElementById('timer');
            if (remainingMs <= 0) {
                timerElement.textContent = '‚è∞ Timer: Completed';
                timerElement.style.background = '#d4edda';
                return;
            }
            
            const minutes = Math.floor(remainingMs / 1000 / 60);
            const seconds = Math.floor((remainingMs / 1000) % 60);
            timerElement.textContent = `‚è∞ Timer: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function startSyncMonitoring() {
            if (syncInterval) clearInterval(syncInterval);
            
            // Simulate continuous monitoring (like MainDashboard does)
            syncInterval = setInterval(async () => {
                try {
                    const processingResponse = await fetch(`/api/processing-status/${TEST_USER_ID}`);
                    const accessResponse = await fetch(`/api/platform-access/${TEST_USER_ID}`);
                    
                    if (processingResponse.ok && accessResponse.ok) {
                        const processingData = await processingResponse.json();
                        const accessData = await accessResponse.json();
                        
                        const platformData = processingData.data[TEST_PLATFORM];
                        const accessPlatform = accessData.data[TEST_PLATFORM];
                        
                        if (platformData && platformData.active) {
                            // Platform is in loading state
                            if (accessPlatform && accessPlatform.claimed === false) {
                                updatePlatformStatus('acquiring');
                            } else {
                                updatePlatformStatus('not-acquired');
                            }
                        } else {
                            // Platform not in loading state
                            if (accessPlatform && accessPlatform.claimed === true) {
                                updatePlatformStatus('acquired');
                            } else {
                                updatePlatformStatus('not-acquired');
                            }
                        }
                    }
                } catch (error) {
                    // Silent monitoring - don't spam logs
                }
            }, 2000); // Check every 2 seconds
        }

        function updateStatus(type) {
            const statusElement = document.getElementById('syncStatus');
            switch (type) {
                case 'loading':
                    statusElement.textContent = 'üîÑ Synchronization Status: Loading State Active';
                    statusElement.className = 'status loading';
                    break;
                case 'sync':
                    statusElement.textContent = 'üîÑ Synchronization Status: Cross-Device Sync Verified';
                    statusElement.className = 'status sync';
                    break;
                case 'claimed':
                    statusElement.textContent = 'üîÑ Synchronization Status: Platform Acquired';
                    statusElement.className = 'status claimed';
                    break;
                default:
                    statusElement.textContent = 'üîÑ Synchronization Status: Ready to Test';
                    statusElement.className = 'status sync';
            }
        }

        function updatePlatformStatus(status) {
            const platformElement = document.getElementById('platformStatus');
            switch (status) {
                case 'acquiring':
                    platformElement.textContent = 'Acquiring';
                    platformElement.className = 'status-indicator acquiring';
                    break;
                case 'acquired':
                    platformElement.textContent = 'Acquired';
                    platformElement.className = 'status-indicator acquired';
                    break;
                case 'not-acquired':
                    platformElement.textContent = 'Not Acquired';
                    platformElement.className = 'status-indicator not-acquired';
                    break;
            }
        }

        async function resetAll() {
            log('üîÑ Resetting all test data...');
            
            try {
                // Clear processing status
                await fetch(`/api/processing-status/${TEST_USER_ID}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platform: TEST_PLATFORM })
                });
                
                // Clear platform access
                await fetch(`/api/platform-access/${TEST_USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platform: TEST_PLATFORM, claimed: false })
                });
                
                log('‚úÖ All test data cleared');
                
                // Clear intervals
                if (syncInterval) clearInterval(syncInterval);
                if (timerInterval) clearInterval(timerInterval);
                
                // Reset UI
                updateStatus('default');
                updateTimerDisplay(0);
                updatePlatformStatus('not-acquired');
                
            } catch (error) {
                log(`‚ùå Error resetting: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ Cross-device synchronization test page loaded');
            log('üì± This test simulates multiple devices accessing the same user ID');
            log('üéØ Use this to verify that loading state and timer sync across devices');
        });
    </script>
</body>
</html>
