<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading State Synchronization Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.success:hover {
            background: #218838;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .platform-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .platform-card.loading {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .platform-card.claimed {
            border-color: #28a745;
            background: #d4edda;
        }
        .platform-card.unclaimed {
            border-color: #6c757d;
            background: #f8f9fa;
        }
        .timer {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        .loading-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üîç Loading State Synchronization Test</h1>
    <p>This test verifies that loading states are properly synchronized across devices and that the guard system works correctly.</p>

    <div class="test-section">
        <h2>üß™ Test Controls</h2>
        <button class="test-button" onclick="startTest()">üöÄ Start Comprehensive Test</button>
        <button class="test-button danger" onclick="clearAllTimers()">üóëÔ∏è Clear All Timers</button>
        <button class="test-button success" onclick="simulateCrossDeviceSync()">üîÑ Simulate Cross-Device Sync</button>
        <button class="test-button" onclick="testGuardSystem()">üõ°Ô∏è Test Guard System</button>
        <button class="test-button" onclick="clearLog()">üßπ Clear Log</button>
    </div>

    <div class="test-section">
        <h2>üìä Platform Status Monitor</h2>
        <div class="platform-grid" id="platformGrid">
            <!-- Platform cards will be populated here -->
        </div>
    </div>

    <div class="test-section">
        <h2>üìù Test Log</h2>
        <div class="log" id="testLog"></div>
    </div>

    <div class="test-section">
        <h2>üîß Manual Timer Control</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <h4>Instagram</h4>
                <button class="test-button" onclick="startTimer('instagram', 15)">Start 15min</button>
                <button class="test-button danger" onclick="clearTimer('instagram')">Clear</button>
            </div>
            <div>
                <h4>Twitter</h4>
                <button class="test-button" onclick="startTimer('twitter', 15)">Start 15min</button>
                <button class="test-button danger" onclick="clearTimer('twitter')">Clear</button>
            </div>
            <div>
                <h4>Facebook</h4>
                <button class="test-button" onclick="startTimer('facebook', 20)">Start 20min</button>
                <button class="test-button danger" onclick="clearTimer('facebook')">Clear</button>
            </div>
            <div>
                <h4>LinkedIn</h4>
                <button class="test-button" onclick="startTimer('linkedin', 15)">Start 15min</button>
                <button class="test-button danger" onclick="clearTimer('linkedin')">Clear</button>
            </div>
        </div>
    </div>

    <script>
        let testRunning = false;
        let testInterval = null;
        const platforms = ['instagram', 'twitter', 'facebook', 'linkedin'];
        
        // Logging function
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            // Also log to console for debugging
            console.log(`[${timestamp}] ${message}`);
        }

        // Clear log
        function clearLog() {
            document.getElementById('testLog').textContent = '';
        }

        // Get timer data for a platform
        function getTimerData(platform) {
            try {
                const countdown = localStorage.getItem(`${platform}_processing_countdown`);
                const info = localStorage.getItem(`${platform}_processing_info`);
                
                if (!countdown || !info) return null;
                
                const endTime = parseInt(countdown);
                const processingInfo = JSON.parse(info);
                
                if (Number.isNaN(endTime)) return null;
                
                return {
                    endTime,
                    startTime: processingInfo.startTime || Date.now(),
                    username: processingInfo.username || 'Unknown',
                    platform: processingInfo.platform
                };
            } catch (error) {
                return null;
            }
        }

        // Check if platform is loading
        function isPlatformLoading(platform) {
            const timerData = getTimerData(platform);
            if (!timerData) return false;
            
            const now = Date.now();
            return now < timerData.endTime;
        }

        // Start timer for a platform
        function startTimer(platform, durationMinutes) {
            const now = Date.now();
            const durationMs = durationMinutes * 60 * 1000;
            const endTime = now + durationMs;
            
            // Set countdown
            localStorage.setItem(`${platform}_processing_countdown`, endTime.toString());
            
            // Set processing info
            const processingInfo = {
                platform,
                username: `testuser_${platform}`,
                startTime: now,
                endTime,
                totalDuration: durationMs,
                isExtension: false
            };
            localStorage.setItem(`${platform}_processing_info`, JSON.stringify(processingInfo));
            
            log(`‚úÖ Started ${durationMinutes}min timer for ${platform}`, 'success');
            updatePlatformGrid();
        }

        // Clear timer for a platform
        function clearTimer(platform) {
            localStorage.removeItem(`${platform}_processing_countdown`);
            localStorage.removeItem(`${platform}_processing_info`);
            log(`üóëÔ∏è Cleared timer for ${platform}`, 'info');
            updatePlatformGrid();
        }

        // Clear all timers
        function clearAllTimers() {
            platforms.forEach(platform => {
                clearTimer(platform);
            });
            log(`üóëÔ∏è Cleared all timers`, 'info');
        }

        // Update platform grid display
        function updatePlatformGrid() {
            const grid = document.getElementById('platformGrid');
            grid.innerHTML = '';
            
            platforms.forEach(platform => {
                const timerData = getTimerData(platform);
                const isLoading = isPlatformLoading(platform);
                
                const card = document.createElement('div');
                card.className = `platform-card ${isLoading ? 'loading' : 'unclaimed'}`;
                
                let statusText = 'Not Acquired';
                let statusClass = 'unclaimed';
                
                if (isLoading) {
                    statusText = 'Acquiring';
                    statusClass = 'loading';
                }
                
                const now = Date.now();
                const remainingMs = timerData ? Math.max(0, timerData.endTime - now) : 0;
                const remainingMinutes = Math.ceil(remainingMs / 60000);
                const remainingSeconds = Math.ceil(remainingMs / 1000);
                
                const progress = timerData ? Math.min(100, Math.max(0, ((now - timerData.startTime) / (timerData.endTime - timerData.startTime)) * 100)) : 0;
                
                card.innerHTML = `
                    <h3>${platform.charAt(0).toUpperCase() + platform.slice(1)}</h3>
                    <div class="status ${statusClass}">${statusText}</div>
                    ${isLoading ? `
                        <div class="timer">${remainingMinutes}:${(remainingSeconds % 60).toString().padStart(2, '0')}</div>
                        <div class="loading-bar">
                            <div class="loading-fill" style="width: ${progress}%"></div>
                        </div>
                        <small>Username: ${timerData.username}</small>
                    ` : ''}
                `;
                
                grid.appendChild(card);
            });
        }

        // Simulate cross-device synchronization
        function simulateCrossDeviceSync() {
            log('üîÑ Simulating cross-device synchronization...', 'info');
            
            // Simulate storage event
            const event = new StorageEvent('storage', {
                key: 'instagram_processing_countdown',
                newValue: localStorage.getItem('instagram_processing_countdown'),
                oldValue: null,
                url: window.location.href
            });
            
            window.dispatchEvent(event);
            log('üì° Dispatched storage event for cross-device sync', 'success');
        }

        // Test guard system
        function testGuardSystem() {
            log('üõ°Ô∏è Testing guard system...', 'info');
            
            // Check if any platform is loading
            const loadingPlatforms = platforms.filter(platform => isPlatformLoading(platform));
            
            if (loadingPlatforms.length > 0) {
                log(`‚ö†Ô∏è Guard should redirect: ${loadingPlatforms.length} platform(s) in loading state`, 'error');
                loadingPlatforms.forEach(platform => {
                    const timerData = getTimerData(platform);
                    const remainingMinutes = Math.ceil((timerData.endTime - Date.now()) / 60000);
                    log(`  - ${platform}: ${remainingMinutes}min remaining`, 'error');
                });
            } else {
                log('‚úÖ Guard should allow access: No platforms in loading state', 'success');
            }
        }

        // Comprehensive test
        function startTest() {
            if (testRunning) {
                log('‚èπÔ∏è Stopping test...', 'info');
                testRunning = false;
                if (testInterval) {
                    clearInterval(testInterval);
                    testInterval = null;
                }
                return;
            }
            
            log('üöÄ Starting comprehensive loading state test...', 'success');
            testRunning = true;
            
            // Start timers for different platforms
            startTimer('instagram', 15);
            setTimeout(() => startTimer('twitter', 15), 2000);
            setTimeout(() => startTimer('facebook', 20), 4000);
            
            // Run continuous monitoring
            testInterval = setInterval(() => {
                if (!testRunning) return;
                
                updatePlatformGrid();
                
                // Check for expired timers
                platforms.forEach(platform => {
                    const timerData = getTimerData(platform);
                    if (timerData && Date.now() >= timerData.endTime) {
                        log(`‚è∞ Timer expired for ${platform}`, 'info');
                        clearTimer(platform);
                    }
                });
                
                // Test guard system every 10 seconds
                if (Date.now() % 10000 < 1000) {
                    testGuardSystem();
                }
            }, 1000);
            
            log('‚úÖ Test started - monitoring loading states...', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Loading State Synchronization Test initialized', 'success');
            updatePlatformGrid();
            
            // Update platform grid every second
            setInterval(updatePlatformGrid, 1000);
            
            // Listen for storage events
            window.addEventListener('storage', (e) => {
                log(`üì° Storage event: ${e.key} changed`, 'info');
                updatePlatformGrid();
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (testInterval) {
                clearInterval(testInterval);
            }
        });
    </script>
</body>
</html>
