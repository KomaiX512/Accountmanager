<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immediate Sync Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .loading { background: #fff3cd; color: #856404; }
        .claimed { background: #d4edda; color: #155724; }
        .unclaimed { background: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .start { background: #28a745; color: white; }
        .check { background: #17a2b8; color: white; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 20px 0; max-height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Immediate Sync Test</h1>
        <p>Test the immediate synchronization of loading state and platform access status.</p>
        
        <div class="status unclaimed" id="currentStatus">Status: Not Acquired</div>
        
        <div>
            <button class="start" onclick="startLoading()">Start Loading State</button>
            <button class="check" onclick="checkStatus()">Check Status</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        const TEST_USER_ID = 'test-user-123';
        const TEST_PLATFORM = 'instagram';
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollTop + 1000;
        }

        async function startLoading() {
            log('üöÄ Starting loading state test...');
            
            try {
                const now = Date.now();
                const durationMs = 15 * 60 * 1000; // 15 minutes
                const endTime = now + durationMs;
                
                log(`‚è∞ Setting timer: ${new Date(endTime).toISOString()}`);
                
                // Step 1: Save processing status
                const processingResponse = await fetch(`/api/processing-status/${TEST_USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: TEST_PLATFORM,
                        startTime: now,
                        endTime: endTime,
                        totalDuration: durationMs,
                        username: 'testuser'
                    })
                });
                
                if (processingResponse.ok) {
                    log('‚úÖ Processing status saved to backend');
                } else {
                    log(`‚ùå Failed to save processing status: ${processingResponse.status}`);
                    return;
                }
                
                // Step 2: Mark platform as NOT claimed
                const accessResponse = await fetch(`/api/platform-access/${TEST_USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: TEST_PLATFORM,
                        claimed: false,
                        username: 'testuser'
                    })
                });
                
                if (accessResponse.ok) {
                    log('‚úÖ Platform marked as NOT claimed (loading state)');
                } else {
                    log(`‚ùå Failed to mark platform as NOT claimed: ${accessResponse.status}`);
                    return;
                }
                
                log('üéØ Loading state started! Now check status on another device...');
                updateStatus();
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        async function checkStatus() {
            log('üîç Checking current status...');
            
            try {
                // Check processing status
                const processingResponse = await fetch(`/api/processing-status/${TEST_USER_ID}`);
                if (processingResponse.ok) {
                    const processingData = await processingResponse.json();
                    log(`üìä Processing status: ${JSON.stringify(processingData, null, 2)}`);
                } else {
                    log(`‚ùå Failed to get processing status: ${processingResponse.status}`);
                }
                
                // Check platform access status
                const accessResponse = await fetch(`/api/platform-access/${TEST_USER_ID}`);
                if (accessResponse.ok) {
                    const accessData = await accessResponse.json();
                    log(`üîë Platform access status: ${JSON.stringify(accessData, null, 2)}`);
                } else {
                    log(`‚ùå Failed to get platform access status: ${accessResponse.status}`);
                }
                
                updateStatus();
                
            } catch (error) {
                log(`‚ùå Error checking status: ${error.message}`);
            }
        }

        function updateStatus() {
            const statusElement = document.getElementById('currentStatus');
            statusElement.textContent = 'Status: Loading State Active';
            statusElement.className = 'status loading';
        }

        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ Immediate sync test page loaded');
            log('üì± Use this page on one device, then check status on another device with same user ID');
        });
    </script>
</body>
</html>
