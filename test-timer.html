<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .timer-display {
            font-size: 48px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            color: #333;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.running { background: #d4edda; color: #155724; }
        .status.completed { background: #cce5ff; color: #004085; }
        .status.error { background: #f8d7da; color: #721c24; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .start { background: #28a745; color: white; }
        .reset { background: #dc3545; color: white; }
        .debug { background: #17a2b8; color: white; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Timer Synchronization Test</h1>
        <p>This page tests the timer synchronization to ensure it's not being skipped.</p>
        
        <div class="timer-display" id="timerDisplay">--:--</div>
        <div class="status running" id="status">Ready to start timer</div>
        
        <div class="controls">
            <button class="start" onclick="startTimer()">Start 15-Minute Timer</button>
            <button class="reset" onclick="resetTimer()">Reset Timer</button>
            <button class="debug" onclick="showDebugInfo()">Show Debug Info</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let timerInterval;
        let endTime;
        let isRunning = false;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollTop + 1000;
        }

        function updateDisplay() {
            if (!isRunning || !endTime) {
                document.getElementById('timerDisplay').textContent = '--:--';
                return;
            }

            const now = Date.now();
            const remaining = Math.max(0, endTime - now);
            
            if (remaining <= 0) {
                completeTimer();
                return;
            }

            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (isRunning) {
                log('‚ö†Ô∏è Timer is already running');
                return;
            }

            const now = Date.now();
            const durationMs = 15 * 60 * 1000; // 15 minutes
            endTime = now + durationMs;
            isRunning = true;

            // Save to localStorage
            localStorage.setItem('test_processing_countdown', endTime.toString());
            localStorage.setItem('test_processing_info', JSON.stringify({
                platform: 'test',
                username: 'testuser',
                startTime: now,
                endTime: endTime,
                totalDuration: durationMs
            }));

            log(`üî• TIMER STARTED: ${new Date(now).toISOString()}`);
            log(`üî• END TIME: ${new Date(endTime).toISOString()}`);
            log(`üî• DURATION: 15 minutes (${durationMs}ms)`);

            // Start the timer
            timerInterval = setInterval(updateDisplay, 1000);
            updateDisplay();

            document.getElementById('status').textContent = 'Timer is running...';
            document.getElementById('status').className = 'status running';
        }

        function completeTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            
            log('üéâ TIMER COMPLETED: 15 minutes elapsed');
            document.getElementById('status').textContent = 'Timer completed successfully!';
            document.getElementById('status').className = 'status completed';
            
            // Clean up localStorage
            localStorage.removeItem('test_processing_countdown');
            localStorage.removeItem('test_processing_info');
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            endTime = null;
            
            log('üîÑ TIMER RESET: All timer data cleared');
            document.getElementById('status').textContent = 'Timer reset - ready to start';
            document.getElementById('status').className = 'status running';
            
            // Clean up localStorage
            localStorage.removeItem('test_processing_countdown');
            localStorage.removeItem('test_processing_info');
            
            updateDisplay();
        }

        function showDebugInfo() {
            const countdown = localStorage.getItem('test_processing_countdown');
            const info = localStorage.getItem('test_processing_info');
            
            log('üîç DEBUG INFO:');
            log(`  Countdown: ${countdown || 'null'}`);
            log(`  Info: ${info || 'null'}`);
            
            if (countdown && info) {
                try {
                    const infoObj = JSON.parse(info);
                    const now = Date.now();
                    const endTimeNum = parseInt(countdown);
                    const remaining = Math.max(0, endTimeNum - now);
                    
                    log(`  Parsed endTime: ${endTimeNum}`);
                    log(`  Current time: ${now}`);
                    log(`  Remaining: ${remaining}ms`);
                    log(`  End time: ${new Date(endTimeNum).toISOString()}`);
                    log(`  Start time: ${new Date(infoObj.startTime).toISOString()}`);
                    log(`  Duration: ${infoObj.totalDuration}ms`);
                } catch (error) {
                    log(`  Error parsing info: ${error.message}`);
                }
            }
        }

        // Check for existing timer on page load
        window.addEventListener('load', () => {
            const countdown = localStorage.getItem('test_processing_countdown');
            const info = localStorage.getItem('test_processing_info');
            
            if (countdown && info) {
                try {
                    const infoObj = JSON.parse(info);
                    const now = Date.now();
                    const endTimeNum = parseInt(countdown);
                    
                    if (now < endTimeNum) {
                        // Resume existing timer
                        endTime = endTimeNum;
                        isRunning = true;
                        timerInterval = setInterval(updateDisplay, 1000);
                        updateDisplay();
                        
                        log('üîÑ RESUMED EXISTING TIMER');
                        document.getElementById('status').textContent = 'Resumed existing timer';
                        document.getElementById('status').className = 'status running';
                    } else {
                        log('‚ö†Ô∏è Found expired timer data, clearing...');
                        localStorage.removeItem('test_processing_countdown');
                        localStorage.removeItem('test_processing_info');
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Error parsing existing timer: ${error.message}`);
                    localStorage.removeItem('test_processing_countdown');
                    localStorage.removeItem('test_processing_info');
                }
            }
        });

        log('üöÄ Timer test page loaded');
    </script>
</body>
</html>
